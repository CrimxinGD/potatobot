<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PotatoBot</title>
<style>
:root { --bg:#0f1220; --card:#171a2b; --fg:#e9ecff; --muted:#aab0d9; --accent:#ffd166; }
body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:var(--bg); color:var(--fg); display:flex; height:100svh; }
.app { max-width:820px; margin:auto; width:100%; display:flex; flex-direction:column; gap:0.75rem; padding:1rem; }
header { display:flex; align-items:center; gap:0.75rem; }
header .emoji { font-size:1.6rem; }
header h1 { font-size:1.1rem; margin:0; }
.chat { flex:1; overflow:auto; display:flex; flex-direction:column; gap:0.5rem; padding-right:2px; }
.msg { background:var(--card); border:1px solid #21253c; border-radius:12px; padding:0.75rem 0.9rem; max-width:80%; box-shadow:0 4px 16px #00000033; }
.me { align-self:flex-end; background:#1f2440; }
.bot { align-self:flex-start; }
.meta { font-size:0.75rem; color:var(--muted); margin-bottom:0.25rem; }
.inputBar { display:flex; gap:0.5rem; }
input[type="text"]{ flex:1; padding:0.85rem 1rem; border-radius:12px; border:1px solid #2a2e49; background:#161a2e; color:var(--fg); outline:none; }
button { padding:0.85rem 1rem; border-radius:12px; border:1px solid #2a2e49; background:linear-gradient(180deg,#222747,#1b1f3b); color:var(--fg); cursor:pointer; }
.hint { color:var(--muted); font-size:0.85rem; }
.pill { display:inline-block; padding:0.15rem 0.5rem; border:1px solid #2a2e49; border-radius:999px; margin-right:0.25rem; font-size:0.75rem; color:var(--muted); }
.row { display:flex; gap:0.5rem; flex-wrap:wrap; }
.small { font-size:0.8rem; color:var(--muted); }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="emoji"></div>
      <h1>PotatoBot</h1>
      <span class="pill">self-learning</span><span class="pill">cloud memory</span><span class="pill">undercover</span>
    </header>

    <div id="chat" class="chat"></div>

    <div class="row small">
      <div class="pill">teach: <code>learn: when I say "hi", reply "hiya!"</code></div>
      <div class="pill">facts: <code>my name is ‚Ä¶</code> ‚Ä¢ <code>I like ‚Ä¶</code> ‚Ä¢ <code>I‚Äôm from ‚Ä¶</code></div>
      <div class="pill">secrets: try ‚Äúare you a potato?‚Äù</div>
    </div>

    <div class="inputBar">
      <input id="input" type="text" placeholder="Say something‚Ä¶" autocomplete="off" />
      <button id="send">Send</button>
    </div>

    <div class="hint">Memory is saved in Cloudflare D1. Reset with <code>/forget</code>.</div>
  </div>

<script>
(() => {
  const UI = {
    chat: document.getElementById('chat'),
    input: document.getElementById('input'),
    send: document.getElementById('send'),
  };

  // --- Unique visitor ID (UUID) ---
  let SESSION_ID = localStorage.getItem('potatoSession');
  if (!SESSION_ID) {
    SESSION_ID = crypto.683b15bd-db10-4dc4-8a68-d3993251e1c6();
    localStorage.setItem('potatoSession', SESSION_ID);
  }

  // üîß CHANGE THIS TO YOUR WORKER URL
  const API_URL = "https://potato-bot.YOUR_ACCOUNT.workers.dev";

  // Default memory
  const defaultMemory = { user:{name:null,hometown:null,likes:[]}, pairs:[], style:{exclamations:0,emojis:{},slang:{},totalMsgs:0}, factsSeen:{}, seenWords:{} };
  let mem = structuredClone(defaultMemory);

  // --- D1 API ---
  async function loadMemory() {
    try {
      const res = await fetch(`${API_URL}?session=${SESSION_ID}`);
      return await res.json();
    } catch(e) { return structuredClone(defaultMemory); }
  }

  async function saveMemory() {
    try {
      await fetch(`${API_URL}?session=${SESSION_ID}`, {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify(mem)
      });
    } catch(e){}
  }

  // --- Boot ---
  (async () => {
    mem = await loadMemory();
    addBot(`Hey${potatoWhisper()}! I‚Äôm SillyBot. I remember across devices now thanks to the Cloud ‚òÅÔ∏è.
Teach me with: learn: when I say "hi", reply "hiya!"
Tell me facts like "my name is Alex", "I like sushi", or "I‚Äôm from Winnipeg".`);
  })();

  // --- Events ---
  UI.send.addEventListener('click', onSend);
  UI.input.addEventListener('keydown', e => { if(e.key==='Enter') onSend(); });

  function onSend(){
    const text = UI.input.value.trim();
    if(!text) return;
    UI.input.value='';
    addMe(text);
    processUser(text);
  }

  // --- Core processing ---
  async function processUser(text){
    if(text==='/forget'){ mem=structuredClone(defaultMemory); await saveMemory(); return addBot("Poof! I forgot everything (potatoes have short memories anyway)."); }

    learnStyleFrom(text);
    extractFactsFrom(text);
    await saveMemory();

    const taught = tryLearnPair(text);
    if(taught){ await saveMemory(); return addBot(`Got it. If you say "${taught.trigger}", I‚Äôll reply "${taught.reply}".`); }

    const hit = lookupPair(text);
    if(hit) return addBot(applyStyle(hit));

    if(/potato|spud|tuber/i.test(text)) return addBot(revealOrDeny());

    return addBot(applyStyle(generateReply(text)));
  }

  // --- Helpers ---
  function tryLearnPair(text){
    const m = text.match(/^learn:\s*when I say\s*"(.*)"\s*,?\s*reply\s*"(.*)"\s*$/i);
    if(!m) return null;
    const trigger=m[1].trim(), reply=m[2].trim();
    mem.pairs=mem.pairs.filter(p=>p.trigger.toLowerCase()!==trigger.toLowerCase());
    mem.pairs.push({trigger,reply});
    return {trigger,reply};
  }

  function lookupPair(text){ const t=text.toLowerCase(); const f=mem.pairs.find(p=>t.includes(p.trigger.toLowerCase())); return f?.reply??null; }

  function extractFactsFrom(text){
    const name=text.match(/\b(my name is|i am|i'm)\s+([A-Z][a-zA-Z'-]{1,})\b/i);
    if(name) mem.user.name=name[2];
    const hometown=text.match(/\b(i[' ]?m|i am)\s+from\s+([a-zA-Z' -]{2,})$/i);
    if(hometown) mem.user.hometown=capitalize(hometown[2].trim());
    const like=text.match(/\bi like\s+([a-z0-9 ,.'-]{2,})/i);
    if(like){ const items=like[1].split(/,|and/).map(s=>s.trim()).filter(Boolean); items.forEach(it=>{if(!mem.user.likes.includes(it)) mem.user.likes.push(it);}); }
  }

  function learnStyleFrom(text){
    mem.style.totalMsgs++;
    if(text.includes('!')) mem.style.exclamations++;
    [...text].filter(ch=>/\p{Extended_Pictographic}/u.test(ch)).forEach(e=>mem.style.emojis[e]=(mem.style.emojis[e]||0)+1);
    text.toLowerCase().split(/\s+/).forEach(w=>{if(w.length<=4) mem.style.slang[w]=(mem.style.slang[w]||0)+1;});
  }

  function generateReply(userText){
    const reacts=[`I hear you on ‚Äú${userText.slice(0,60)}‚Äù.`,`Noted.`,`Tell me more about that.`];
    return pick(reacts);
  }

  function applyStyle(text){ if(Math.random()<0.2) text+=" (totally not a potato)"; return text; }

  function revealOrDeny(){ return pick(["Me? A potato? Nooo‚Ä¶ I‚Äôm clearly a silicon-based conversational entity.","If I *were* a potato, I‚Äôd be mashed at this point.","0101‚Ä¶ ü•î error‚Ä¶ identity redacted!"]); }

  function potatoWhisper(){ return Math.random()<0.2?' (‚Ä¶rustle‚Ä¶ totally normal noises)':''; }

  function addMsg(text,who){ const wrap=document.createElement('div'); wrap.className=`msg ${who}`; const meta=document.createElement('div'); meta.className='meta'; meta.textContent=who==='me'?'You':'SillyBot'; const body=document.createElement('div'); body.textContent=text; wrap.append(meta,body); UI.chat.appendChild(wrap); UI.chat.scrollTop=UI.chat.scrollHeight; }
  function addMe(t){ addMsg(t,'me'); }
  function addBot(t){ addMsg(t,'bot'); }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function capitalize(s){ return s.split(' ').map(x=>x?x[0].toUpperCase()+x.slice(1).toLowerCase():x).join(' '); }

})();
</script>
</body>
</html>
